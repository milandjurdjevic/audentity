# Audentity [![latest version](https://img.shields.io/nuget/v/Audentity)](https://www.nuget.org/packages/Audentity)

### Auditing library for Entity Framework

The Audentity project is designed to enhance data integrity and accountability within applications utilizing the Entity
Framework
for data access. By integrating specialized auditing functionality, the project enables developers to effortlessly track
and log changes to the database, including inserts, updates, and deletions. This empowers organizations to maintain a
clear and transparent record of data modifications, ensuring compliance, detecting unauthorized activities, and
facilitating
forensic analysis when necessary. The project aims to streamline the implementation of robust auditing features, making
it seamless for developers to integrate comprehensive data tracking capabilities into their Entity Framework-based
applications.

## Usage

To collect traces, you want to catch the state of the `Microsoft.EntityFrameworkCore.ChangeTracking.ChangeTracker`
before saving changes. That can be done simply by overriding the `SaveChanges()` & `SaveChangesAsync(CancellationToken)`
methods in your `Microsoft.EntityFrameworkCore.DbContext` implementation.

```csharp
public class Database : DbContext
{
    public override async Task<int> SaveChangesAsync(CancellationToken cancellationToken = new())
    {
        ImmutableList<EntityTrace> traces = ChangeTracker.Entries()
            .Select(EntityTrace.FromEntry)
            .ToImmutableList();
        
        int result = await base.SaveChangesAsync(cancellationToken);
        // Process traces...
        return result;
    }
}
```

### Shadow Entries

If you have many-to-many relationships in your database model, Entity Framework will generate a shadow entity that
represents a reference between two entities - unless you have defined such an entity yourself.

```csharp
public class Project
{
    public Guid Id { get; set; }
    public IEnumerable<User> Users { get; set; }
}

public class User
{
    public Guid Id { get; set; }
    public IEnumerable<Project> Projects { get; set; }
}

// Shadow entity generated by Entity Framework:
public class ProjectUser
{
    public Guid ProjectId { get; set; }
    public Guid UserId { get; set; }
}
```

Those entities, even if they are not defined in the code itself, will still end up in our trace collection.
To exclude them from traces, you can filter all entries by their CLR type before collecting traces.

```csharp
ChangeTracker.Entries()
    .Where(e => e.Metadata.ClrType != typeof(Dictionary<string, object>))
    .Select(Entity.FromEntry);
```